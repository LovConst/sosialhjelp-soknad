FROM node as node-builder

ADD / /source
WORKDIR /source
ENV CI=true
RUN npm ci && npm run build

FROM node as node-image

WORKDIR /app
COPY --from=node-builder /source/build /app
COPY heroku.js /app
COPY set-resource-path.sh /app
COPY heroku-index.html /app/index.html

RUN npm install express

CMD ./set-resource-path.sh && node heroku.js
